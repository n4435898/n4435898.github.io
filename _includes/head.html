<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  {%- capture seo_tags -%}
    {% seo title=false %}
  {%- endcapture -%}

  <!-- Setup Open Graph image -->

  {% if page.image %}
    {% assign src = page.image.path | default: page.image %}

    {% unless src contains '://' %}
      {%- capture img_url -%}
        {% include media-url.html src=src subpath=page.media_subpath absolute=true %}
      {%- endcapture -%}

      {%- capture old_url -%}{{ src | absolute_url }}{%- endcapture -%}
      {%- capture new_url -%}{{ img_url }}{%- endcapture -%}

      {% assign seo_tags = seo_tags | replace: old_url, new_url %}
    {% endunless %}

  {% elsif site.social_preview_image %}
    {%- capture img_url -%}
      {% include media-url.html src=site.social_preview_image absolute=true %}
    {%- endcapture -%}

    {%- capture og_image -%}
      <meta property="og:image" content="{{ img_url }}" />
    {%- endcapture -%}

    {%- capture twitter_image -%}
      <meta name="twitter:card" content="summary_large_image" />
      <meta property="twitter:image" content="{{ img_url }}" />
    {%- endcapture -%}

    {% assign old_meta_clip = '<meta name="twitter:card" content="summary" />' %}
    {% assign new_meta_clip = og_image | append: twitter_image %}
    {% assign seo_tags = seo_tags | replace: old_meta_clip, new_meta_clip %}
  {% endif %}

  {{ seo_tags }}

  <title>
    {%- unless page.layout == 'home' -%}
      {{ page.title | append: ' | ' }}
    {%- endunless -%}
    {{ site.title }}
  </title>

  {% include_cached favicons.html %}

  <!-- Resource Hints -->
  {% unless site.assets.self_host.enabled %}
    {% for hint in site.data.origin.cors.resource_hints %}
      {% for link in hint.links %}
        <link rel="{{ link.rel }}" href="{{ hint.url }}" {{ link.opts | join: ' ' }}>
      {% endfor %}
    {% endfor %}
  {% endunless %}

  <!-- Bootstrap -->
  {% unless jekyll.environment == 'production' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  {% endunless %}

  <!-- Theme style -->
  <link rel="stylesheet" href="{{ '/assets/css/:THEME.css' | replace: ':THEME', site.theme | relative_url }}">

  <!-- Core theme scripts (lazy-load, image-swap, TOC, etc.) -->
  <script
    src="{{ '/assets/js/dist/theme.min.js' | relative_url }}"
    data-turbolinks-eval="false"
  ></script>


  <!-- Google Fonts: Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;500;700&display=swap" rel="stylesheet">

  <!-- Web Font -->
  <link rel="stylesheet" href="{{ site.data.origin[type].webfonts | relative_url }}">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="{{ site.data.origin[type].fontawesome.css | relative_url }}">

  <!-- 3rd-party Dependencies -->

  {% if site.toc and page.toc %}
    <link rel="stylesheet" href="{{ site.data.origin[type].toc.css | relative_url }}">
  {% endif %}

  {% if page.layout == 'post' or page.layout == 'page' or page.layout == 'home' %}
    <link rel="stylesheet" href="{{ site.data.origin[type]['lazy-polyfill'].css | relative_url }}">
  {% endif %}

  {% if page.layout == 'page' or page.layout == 'post' %}
    <!-- Image Popup -->
    <link rel="stylesheet" href="{{ site.data.origin[type].glightbox.css | relative_url }}">
  {% endif %}

  <!-- Scripts -->
   <script src="{{ '/assets/js/turbolinks.js' | relative_url }}"></script>
<script>Turbolinks.start();</script>

  <script>
    document.addEventListener('turbolinks:click', function (event) {
      const url = new URL(event.data.url, window.location.origin);
      const path = url.pathname;

      // Add custom logic here:
      // Disable Turbolinks for any URL under `/page/` or `/posts/`
      const blockPrefixes = ['/page/', '/posts/', '/blog/', '/about/', '/search/'];
      const shouldBlock = blockPrefixes.some((prefix) => path.startsWith(prefix));

      if (shouldBlock) {
        // Let the browser handle it normally (i.e. full reload)
        event.preventDefault();
        window.location.href = url.href;
      }
    });
  </script>

  <script>
    document.addEventListener('turbolinks:load', function () {
      const sidebar = document.getElementById('sidebar');
      const indicator = document.getElementById('sidebar-indicator');
      const nav = sidebar.querySelector('nav');
      const tabs = Array.from(sidebar.querySelectorAll('[data-sidebar-tab]'));

      // Normalize a path: strip trailing slashes, but keep "/" as "/"
      function normalize(p) {
        p = p.replace(/\/+$/, '');
        return p === '' ? '/' : p;
      }

      const path = normalize(window.location.pathname);

      // Build array of [tabElement, href] with normalized hrefs
      const tabLinks = tabs.map((tab) => {
        const hrefRaw = tab.querySelector('a.nav-link').getAttribute('href');
        return [tab, normalize(hrefRaw)];
      });

      // 1) Find all tabs where path starts with href
      const matches = tabLinks.filter(([tab, href]) => {
        // always allow exact match
        if (href === path) return true;
        // prefix match, but never match root "/" as a prefix for everything
        return href !== '/' && path.startsWith(href + '/');
      });

      // 2) Pick the longest-href match (best specificity)
      let selectedTab = null;
      if (matches.length) {
        selectedTab = matches.sort((a, b) => b[1].length - a[1].length)[0][0];
      } else {
        // 3) Fallback: exact path match
        const exact = tabLinks.find(([tab, href]) => href === path);
        selectedTab = exact ? exact[0] : tabs[0];
      }

      // 4) Apply .active only to the chosen tab
      tabs.forEach((tab) => tab.classList.toggle('active', tab === selectedTab));

      // 5) Positioning logic
      const rects = { nav: nav.getBoundingClientRect() };
      function moveIndicatorTo(tab) {
        if (!tab) return;
        const rect = tab.getBoundingClientRect();
        const navRect = rects.nav;
        indicator.style.top = rect.top - navRect.top + 'px';
        indicator.style.height = rect.height + 'px';
      }

      // INITIAL jump
      moveIndicatorTo(selectedTab);

      // AFTER paint: enable smooth transitions
      requestAnimationFrame(() => {
        indicator.classList.add('moving');
      });

      // 6) Event bindings
      window.addEventListener('resize', () => moveIndicatorTo(selectedTab));
      nav.addEventListener('mouseleave', () => moveIndicatorTo(selectedTab));
      tabs.forEach((tab) => {
        tab.addEventListener('mouseenter', () => moveIndicatorTo(tab));
        tab.addEventListener('mouseleave', () => moveIndicatorTo(selectedTab));
        tab.addEventListener('click', () => {
          selectedTab = tab;
          moveIndicatorTo(selectedTab);
        });
      });
    });
  </script>

  {% include js-selector.html lang=lang %}

  {% if jekyll.environment == 'production' %}
    <!-- PWA -->
    {% if site.pwa.enabled %}
      <script
        defer
        src="{{ '/app.min.js' | relative_url }}?baseurl={{ site.baseurl | default: '' }}&register={{ site.pwa.cache.enabled }}"
      ></script>
    {% endif %}

    <!-- Web Analytics -->
    {% for analytics in site.analytics %}
      {% capture str %}{{ analytics }}{% endcapture %}
      {% assign platform = str | split: '{' | first %}
      {% if site.analytics[platform].id and site.analytics[platform].id != empty %}
        {% include analytics/{{ platform }}.html %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% include metadata-hook.html %}
</head>
